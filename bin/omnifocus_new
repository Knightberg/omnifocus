#!/usr/bin/ruby -w

require 'rubygems'
require 'mechanize'
require 'appscript'

project_name = ARGV.shift
title = ($stdin.tty? ? ARGV.join(" ") : $stdin.read).strip

include Appscript

omnifocus = app('OmniFocus').default_document

unless project_name && ! title.empty? then
  cmd = File.basename $0
  projects = omnifocus.sections.projects.name.get.flatten.sort

  abort "usage: #{cmd} project title\n\nprojects = nil, #{projects.join ", "}"
end

if project_name == "nil" then
  omnifocus.make :new => :inbox_task, :with_properties => {:name => title}
else
  projects = omnifocus.sections.projects[its.name.eq(project_name)]
  project = projects.get.flatten.grep(Appscript::Reference).first
  project.make :new => :task, :with_properties => {:name => title}

  puts "created task in #{project_name}: #{title}"
end
